---
name: 上下文管理系统落地
overview: 将技术文档中的上下文管理系统实现为一个独立的 npm CLI 工具（TypeScript），在当前工作区开发，提供核心库 + CLI + HTTP API + OpenClaw Skill 集成，方便 bot 主人通过 npm install 一键安装。
todos:
  - id: skeleton
    content: "Phase 1: 项目骨架 -- package.json、tsconfig.json、类型定义（types.ts）、配置系统（config.ts）、CLI 入口"
    status: pending
  - id: storage
    content: "Phase 2: 核心存储 -- hard-state.ts、assertions.ts 文件读写、CLI init/state/assertions 命令、模板文件"
    status: pending
  - id: brain
    content: "Phase 3: Prompt Builder + Extractor -- prompt builder 拼接逻辑、extractor 规则链（决策/todo/否定/事实）、单元测试"
    status: pending
  - id: lifecycle
    content: "Phase 4: Session Manager + Phase Detector -- 会话生命周期管理、阶段感知状态机、CLI turn/review 命令"
    status: pending
  - id: integration
    content: "Phase 5: HTTP Server + OpenClaw Skills + README -- fastify API 服务、SKILL.md 文件、完整 README 文档"
    status: pending
isProject: false
---

# OpenClaw 上下文管理系统落地计划

## 定位

独立 npm 包 `openclaw-context-manager`，提供：

- **核心库** -- 可被任意 Node.js/TS 项目 import 使用
- **CLI 工具** -- `ocm` 命令行，方便 bot 主人手动操作和脚本集成
- **轻量 HTTP Server** -- 暴露 REST API（GET /state, POST /assertion, POST /review）
- **OpenClaw Skill 目录** -- 可直接复制到 `~/.openclaw/skills/` 实现与 OpenClaw 的深度集成

## 技术选型

- **语言**: TypeScript（ESM，target ES2022）
- **运行时**: Node.js >= 18
- **依赖（最小化）**:
  - `yaml` -- YAML 读写（Hard State）
  - `commander` -- CLI 框架
  - `fastify` -- 轻量 HTTP server（仅在 server 模式启用）
  - `nanoid` -- assertion ID 生成
  - `vitest` -- 测试
- **不引入**: 向量数据库、embedding 服务、heavy ML 组件（遵循文档约束）

## 项目结构

```
e:\code\RESIDUE\openclaw-context-manager\
├── package.json
├── tsconfig.json
├── README.md
├── bin/
│   └── ocm.ts                     # CLI 入口（commander）
├── src/
│   ├── index.ts                    # 库入口，导出所有核心模块
│   ├── types.ts                    # HardState, Assertion, Phase 等类型定义
│   ├── config.ts                   # 配置加载（默认值 + 用户 config 文件 + 环境变量）
│   ├── state/
│   │   ├── hard-state.ts           # Hard State CRUD（YAML 文件读写）
│   │   └── assertions.ts           # Assertions CRUD（JSON 文件，append-only）
│   ├── prompt/
│   │   └── builder.ts              # Prompt 构建器（拼接 HardState + Assertions + UserInput）
│   ├── extractor/
│   │   ├── index.ts                # Extractor 主逻辑（调用规则链）
│   │   └── rules.ts                # 正则/模板规则集（决策、todo、否定、事实）
│   ├── phase/
│   │   └── detector.ts             # 阶段检测状态机（setup/planning/execution/review）
│   ├── session/
│   │   └── manager.ts              # 会话生命周期（start/end/review hook）
│   └── server/
│       └── index.ts                # HTTP API server（GET /state, POST /assertion, POST /review）
├── skills/                          # OpenClaw Skill 集成
│   ├── ocm-review/
│   │   └── SKILL.md                # /review slash command
│   └── ocm-state/
│       └── SKILL.md                # /state slash command
├── templates/
│   ├── current_state.yaml          # 默认初始 Hard State 模板
│   └── config.example.json         # 示例配置文件
└── test/
    ├── extractor.test.ts
    ├── prompt-builder.test.ts
    ├── hard-state.test.ts
    ├── assertions.test.ts
    └── phase-detector.test.ts
```

## 核心模块设计

### 1. 类型定义（`src/types.ts`）

```typescript
// Hard State -- 不可丢失
interface HardState {
  goal: string;
  constraints: string[];
  system_prompt?: string;
  capabilities: string[];
  session_metadata?: Record<string, unknown>;
}

// Assertion -- 可推导断言
interface Assertion {
  id: string;
  type: 'fact' | 'decision' | 'rejection' | 'todo';
  content: string;
  source: 'auto-extract' | 'manual' | 'review';
  status: 'pending' | 'confirmed';
  time: string; // ISO 8601
  phase?: Phase;
}

type Phase = 'setup' | 'planning' | 'execution' | 'review';
```

### 2. Prompt Builder（`src/prompt/builder.ts`）

核心逻辑：`HardState` + 最新 N 条 Assertions（N 可配置，默认 10）+ 当前用户输入 -> 最终 Prompt。严格遵循文档第五节 Turn-level 流程。

### 3. Extractor（`src/extractor/`）

基于正则和关键词匹配的规则链：

- 决策规则：匹配 "决定/选择/采用/确定" 等 -> `decision`
- Todo 规则：匹配 "需要/TODO/待办/下一步" 等 -> `todo`
- 否定规则：匹配 "不要/不能/禁止/不得" 等 -> `rejection`
- 事实规则：匹配 "已经/完成了/结果是" 等 -> `fact`

规则可通过配置文件扩展（用户自定义正则模式）。

### 4. Phase Detector（`src/phase/detector.ts`）

简单状态机 + 触发词检测：

- `setup`: 会话开始、目标确认阶段
- `planning`: 计划、方案讨论阶段
- `execution`: 执行、实施阶段
- `review`: 回顾、总结阶段

阶段影响 Extractor 行为（如文档第六节所述）。

### 5. Session Manager（`src/session/manager.ts`）

管理会话生命周期：

- `start()` -- 加载 HardState + Assertions，初始化 phase
- `turn(userInput, modelOutput)` -- 构建 prompt、运行 extractor、丢弃 ephemeral
- `review()` -- 触发强制汇总
- `end()` -- 可选调用 review hook，清理临时文件

### 6. HTTP Server（`src/server/index.ts`）

```
GET  /state              -> 返回 HardState + 最新 N 条 Assertions
POST /assertion           -> 手动新增断言
POST /review              -> 触发 review 汇总
GET  /health              -> 健康检查
```

默认端口可配置（如 7799）。

## CLI 命令设计

```bash
# 初始化数据目录和配置
ocm init [--data-dir ./data]

# 查看当前状态
ocm state

# 查看断言列表
ocm assertions [--limit 20] [--type decision]

# 手动添加断言
ocm assert --type decision --content "选择方案A"

# 运行一次 turn（管道模式，适合脚本集成）
echo "用户输入" | ocm turn --model-output "模型输出"

# 触发 review
ocm review

# 启动 HTTP server
ocm serve [--port 7799]

# 导出/备份状态
ocm export --output backup.tar.gz
```

## 安装流程（bot 主人视角）

```bash
# 1. 全局安装
npm install -g openclaw-context-manager

# 2. 初始化（在 bot 工作目录）
cd /path/to/my-bot
ocm init

# 3. 可选：启动 API server
ocm serve --port 7799

# 4. 可选：复制 skills 到 OpenClaw
cp -r node_modules/openclaw-context-manager/skills/* ~/.openclaw/skills/
```

## 配置文件（`ocm.config.json`）

```json
{
  "dataDir": "./data/openclaw",
  "assertions": {
    "maxActive": 100,
    "defaultLimit": 10
  },
  "extractor": {
    "enabled": true,
    "customRules": []
  },
  "server": {
    "port": 7799
  },
  "phase": {
    "autoDetect": true
  }
}
```

## 数据存储布局（遵循技术文档）

```
{dataDir}/
  state/
    current_state.yaml       # Hard State
    assertions.json          # Assertions 列表
    history/                 # Hard State 变更历史（append-only）
  temp/
    session_tmp.txt           # 当前会话临时数据
  logs/
    audit.jsonl              # 审计日志（每条 assertion 的 source/time/hash）
```

## 测试策略

- **约束保全测试**: 模拟 100 次 turn 操作，验证 HardState 中的约束不被误删
- **Extractor 精度**: 准备中/英文测试用例，验证 precision/recall
- **Prompt 大小**: 验证生成的 prompt token 数在预期范围内
- **Phase 状态机**: 验证阶段转换的正确性
- **API 端点**: 集成测试所有 HTTP 端点

## 实施顺序

分 5 个阶段，逐步可交付：

1. **基础骨架** -- package.json、tsconfig、类型定义、配置系统
2. **核心存储** -- HardState 和 Assertions 的文件读写 + CLI init/state/assertions 命令
3. **Prompt Builder + Extractor** -- 核心业务逻辑 + 单元测试
4. **Session Manager + Phase Detector** -- 会话生命周期 + 阶段感知策略
5. **HTTP Server + OpenClaw Skills + README** -- API 服务、集成文件、文档

